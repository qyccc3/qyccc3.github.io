<!DOCTYPE html>
<html lang = "en">
<head>
    <meta charset = "UTF-8">
    <title>United States House Price Index Map</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css" type="text/css">
    <!-- Bootstrap, D3, ajax -->  
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
         // Global variables
         var year = 2022;
         var csvData;
         var type_filter = "traditional";
         var index_filter = "index_nsa";
         var flavor_filter = "all-transactions";
         var curr_selection;

         var prev_circle_idx = -1;
         var prev_color = 0;

         var countySelected = false;

        // Load JSON into SVG
        function loadMap(mapName){
            $.getJSON('json/' + mapName + '.json', function(data){
                const col = document.getElementById("left-col");
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                svg.setAttribute("id", "us-map");
                svg.setAttribute("width", data.width);
                svg.setAttribute("height", data.height);  
                svg.setAttribute("viewBox", data.viewBox);
                const g = document.createElementNS("http://www.w3.org/2000/svg","g");
                for(var state of Object.keys(data.states)){
                     const state_g = document.createElementNS("http://www.w3.org/2000/svg","g");
                     state_g.setAttribute("id", "state");
                     state_g.setAttribute("state-name", state);
                     state_g.setAttribute("view", data.states[state]["viewBox"]);
                     for(var counties of Object.keys(data.states[state]["counties"])){
                        const county_path = document.createElementNS("http://www.w3.org/2000/svg","path");
                        county_path.setAttribute("id", "county");
                        county_path.setAttribute("county-name", counties);
                        county_path.setAttribute("d", data.states[state]["counties"][counties]);
                        state_g.appendChild(county_path);
                    }
                    g.appendChild(state_g);                 
                }
                const border = document.createElementNS("http://www.w3.org/2000/svg","g");
                const border_path = document.createElementNS("http://www.w3.org/2000/svg","path");
                border.setAttribute("id", "border");
                border_path.setAttribute("d", data.border);
                border_path.style.stroke = "black";
                border_path.style.strokeWidth = ".89143px";
                border_path.style.fill = "none";
                border.appendChild(border_path);
                svg.appendChild(g);
                svg.appendChild(border);

                // create a rectangle
               const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");

               col.appendChild(svg);
            });
        };
        // Read dataset CSV
        Promise.all([
            d3.csv('datasets/states_cleaned_data.csv'),
            d3.csv('datasets/counties_cleaned_data.csv')
        ]).then(ready);

        // Assign all the values and create all the functions
        function ready(data){
            states = data[0];
            counties = data[1];
            curr_selection = "us";
            //Gloval Variables
            let allowhover = true;
            var statename; 
            csvData = states;
            display_color(states);
            // Mouse hover over state show status
            document.addEventListener('mouseover', function(event){
                if(allowhover){
                    var target = event.target.parentElement;
                    if(target.id == "state"){
                        if(statename != undefined){
                           change_color(states, statename);
                        }
                        statename = target.getAttribute("state-name");
                        target.style.cssText += 'fill: #FFFAA0;';
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + statename;
                        var result = states.filter(obj => {
                        return obj["state"] === statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                        });
                        display_hist(states, statename);
                        document.getElementById('currentIdx').innerHTML = "<strong>State Current: </strong>" + result[0]["index"];
                        histo = document.getElementById('histogram-img');
                        img_name = 'Prediction Figures' + '/' + statename + '_' + type_filter + '_' + flavor_filter + '.png';
                        histo.src = img_name;
                    }
                    else if(target.id == "county"){
                        countyname = target.getAttribute("county-name");
                        //console.log(countyname);
                    }
                    else{
                        display_color(states);
                        document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
                        document.getElementById('currentIdx').innerHTML = "<strong>State Current: </strong>";
                        document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
                        document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";
                        histo = document.getElementById('histogram-img');
                        histo.src = "./Prediction Figures/main.jpeg";
                    }
                }
            });

            // Click state freeze status and zoom in
            document.addEventListener('click', function(event){
                var target = event.target.parentElement;
                if(target.id == "state"){
                     statename = target.getAttribute("state-name");
                     tonedown_color(states, statename);
                     //target.style.cssText += 'fill: #93C572;';
                     var result = states.filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
                     });
                     display_hist(states, statename);
                     document.getElementById('currentIdx').innerHTML = "<strong>State Current: </strong>" + result[0]["index"];
                     document.getElementById('displayName').innerHTML = "<strong>States: </strong>" + statename;
                     allowhover = false;
                     // Zoom in
                     var svg = document.getElementById("us-map");
                     var statearea = target.getBBox().width *  target.getBBox().height;
                     svg.setAttribute("viewBox", target.getAttribute("view"));
                     //console.log(target.getAttribute("view").split(" "));

                     curr_selection = "state";
                     countySelected = false;
                     prev_circle_idx = -1;
                     prev_color = 0;
                     var state_counties = counties.filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
                     });

                     console.log(state_counties);
                     histo = document.getElementById('histogram-img');
                     img_name = 'Prediction Figures' + '/' + statename + '_' + type_filter + '_' + flavor_filter + '.png';
                     histo.src = img_name;
                     var dropdown = document.getElementById("dropdown-menu-list");
                     while(dropdown.firstChild){
                        dropdown.removeChild(dropdown.firstChild);
                     }
                     display_dropdown(state_counties);

                     //delete counties with 0 index
                     var new_state_counties = [];
                     for(var i = 0; i < state_counties.length; i++){
                        if(state_counties[i]["index"] != 0){
                            new_state_counties.push(state_counties[i]);
                        }
                     }
                     state_counties = new_state_counties;
                     
                     document.getElementById('county-currentIdx').innerHTML = "<strong>County Current: </strong>";
                     document.getElementById('county-name').innerHTML = "<strong>County: </strong>";
                     var sum_index = 0;
                     for(var i = 0; i < state_counties.length; i++){
                        sum_index += parseFloat(state_counties[i]["index"]);
                     }
                     var avg_index = sum_index / state_counties.length;
                     //console.log(avg_index);
                     var circles = document.querySelectorAll("circle");
                     for (var i = 0; i < circles.length; i++){
                           circles[i].remove();
                     }
                     var max = state_counties.reduce(function(prev, curr){
                        return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
                     });
                     var min = state_counties.reduce(function(prev, curr){
                        return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
                     });
                     for(var county of state_counties){
                        var county_path = document.querySelectorAll('[county-name="' + county["county"] + '"]');
                        var bbox = county_path[0].getBBox();
                        cx = bbox.x + bbox.width/2;
                        cy = bbox.y + bbox.height/2;
                        circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
                        // Max Radius = 6
                        radius = 6 * (county["index"] / max["index"]);
                        circle.setAttribute("cx", cx);
                        circle.setAttribute("cy", cy);
                        circle.setAttribute("r", radius);
                        if (county["county"] == max["county"]){
                           circle.setAttribute('fill', '#DE3163');
                        }
                        else if (county["county"] == min["county"]){
                           circle.setAttribute('fill', '#6495ED');
                        }
                        else{
                           circle.setAttribute('fill', '#FFFAA0');
                        }
                        circle.setAttribute("stroke", "black");
                        circle.setAttribute("index", county["index"]);
                        circle.setAttribute("onmouseover", "display_county_stats(this)");
                        // set circle attribute onclick
                        circle.setAttribute("onclick", "show_county_stats(this)");
                        
                        circle.setAttribute("county-name", county_path[0].getAttribute("county-name"));
                        svg.appendChild(circle);
                     }
                }
            }); 
            document.getElementById("clearbtn").onclick = function(){clear()};
            function clear(){
               countySelected = false;
               prev_circle_idx = -1;
               prev_color = 0;
               var states = document.querySelectorAll("[id^='state']");
               for (var i = 0; i < states.length; i++){
                     states[i].style.fill = "";
               }
               allowhover = true;
               document.getElementById('displayName').innerHTML = "<strong>States: </strong>";
               document.getElementById('currentIdx').innerHTML = "<strong>State Current: </strong>";
               document.getElementById('hisMax').innerHTML = "<strong>Max: </strong>";
               document.getElementById('hisMin').innerHTML = "<strong>Min: </strong>";
               document.getElementById('county-currentIdx').innerHTML = "<strong>County Current: </strong>";
               document.getElementById('county-name').innerHTML = "<strong>County: </strong>";

               display_color(csvData);
               var svg = document.getElementById("us-map");
               svg.setAttribute("viewBox", "0 0 989.98 627.07");
               curr_selection = "us";

               var circles = document.querySelectorAll("circle");
               for (var i = 0; i < circles.length; i++){
                     circles[i].remove();
               }

               var dropdown = document.getElementById("dropdown-menu-list");
               while(dropdown.firstChild){
                  dropdown.removeChild(dropdown.firstChild);
               }
            };
         };

         function display_dropdown(data){
            var dropdown = document.getElementById("dropdown-menu-list");
            // sort data on index value from max to min
            data.sort(function(a, b){
               return parseFloat(b["index"]) - parseFloat(a["index"]);
            });
            //console.log(data);
            for(var i = 0; i < data.length; i++){
               var option = document.createElement("li");
               var a = document.createElement("a");
               a.setAttribute("href", "#");
               a.setAttribute("class", "dropdown-item");
               a.setAttribute("county", data[i]["county"]);
               a.onclick = function(){
                  countySelected = true;
                  var countyname = this.getAttribute("county");
                  var result = counties.filter(obj =>{
                     return obj["county"] == countyname && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
                  })
                  // select all circles
                  var circles = document.querySelectorAll("circle");
                  if(prev_circle_idx != -1){
                     circles[prev_circle_idx].setAttribute("fill", prev_color);
                  }
                  prev_circle = countyname;
                  for (var i = 0; i < circles.length; i++){
                        if (circles[i].getAttribute("county-name") == countyname){
                           prev_color = circles[i].getAttribute("fill");
                           circles[i].setAttribute("fill", "green");
                           prev_circle_idx = i;
                        }
                  }
                  document.getElementById('county-currentIdx').innerHTML = "<strong>County Current: </strong>" + result[0]["index"];
                  document.getElementById('county-name').innerHTML = "<strong>County: </strong>" + countyname;
               };
               a.innerText = data[i]["county"].split(",")[0] + " (" + data[i]["index"] + ")";
               if(data[i]["index"] != 0){
                  option.appendChild(a);
                  dropdown.appendChild(option);
               }
            }
         };

         function flavorCheckedOnClick(check){
            var checkboxes = document.getElementsByClassName("filter_flavor");
            for(var i = 0; i < checkboxes.length; i++){
               checkboxes.item(i).checked = false; // uncheck all checkboxes
            }
            flavor_filter = check.id;
            check.checked = true; // check the clicked checkbox
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
               display_hist(csvData, statename);
               histo = document.getElementById('histogram-img');
               img_name = 'Prediction Figures' + '/' + statename + '_' + type_filter + '_' + flavor_filter + '.png';
               histo.src = img_name;
               var state_counties = counties.filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
                     });
               var new_state_counties = [];
               for(var i = 0; i < state_counties.length; i++){
                  if(state_counties[i]["index"] != 0){
                        new_state_counties.push(state_counties[i]);
                  }
               }
               var dropdown = document.getElementById("dropdown-menu-list");
               while(dropdown.firstChild){
                  dropdown.removeChild(dropdown.firstChild);
               }
               state_counties = new_state_counties;
               display_dropdown(state_counties);
               var sum_index = 0;
               for(var i = 0; i < state_counties.length; i++){
                  sum_index += parseFloat(state_counties[i]["index"]);
               }
               var avg_index = sum_index / state_counties.length;
               //console.log(avg_index);
               var circles = document.querySelectorAll("circle");
               for (var i = 0; i < circles.length; i++){
                     circles[i].remove();
               }
               if(state_counties.length > 0){
                  var max = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               var svg = document.getElementById("us-map");
               for(var county of state_counties){
                  var county_path = document.querySelectorAll('[county-name="' + county["county"] + '"]');
                  var bbox = county_path[0].getBBox();
                  cx = bbox.x + bbox.width/2;
                  cy = bbox.y + bbox.height/2;
                  circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
                  // Max Radius = 6
                  radius = 6 * (county["index"] / max["index"]);
                  circle.setAttribute("cx", cx);
                  circle.setAttribute("cy", cy);
                  circle.setAttribute("r", radius);
                  if (county["county"] == max["county"]){
                     circle.setAttribute('fill', '#DE3163');
                  }
                  else if (county["county"] == min["county"]){
                     circle.setAttribute('fill', '#6495ED');
                  }
                  else{
                     circle.setAttribute('fill', '#FFFAA0');
                  }
                  circle.setAttribute("stroke", "black");
                  circle.setAttribute("index", county["index"]);
                  circle.setAttribute("onmouseover", "display_county_stats(this)");
                  // set circle attribute onclick
                  circle.setAttribute("onclick", "show_county_stats(this)");
                  
                  circle.setAttribute("county-name", county_path[0].getAttribute("county-name"));
                  svg.appendChild(circle);
               }
               }
            }
            if(check.id == "all-transactions"){
               var checkboxes = document.getElementsByClassName("filter_type");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = false; // disable all checkboxes
               }
               var slider = document.getElementById("slider-range");
               slider.setAttribute("min", 1975);
            }
            else{
               var checkboxes = document.getElementsByClassName("filter_type");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = true; // disable all checkboxes

               }
               var slider = document.getElementById("slider-range");
               if(slider.value < 1995){
                  year = 1995;
                  slider.setAttribute("value", 1995);
                  show_value(year);
               }
               slider.setAttribute("min", 1995);
            }
        }; 
         function display_county_stats(data){
            if(!countySelected){
               var countyname = data.getAttribute("county-name");
               var result = counties.filter(obj =>{
                  return obj["county"] == countyname && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
               })
               document.getElementById('county-currentIdx').innerHTML = "<strong>County Current: </strong>" + result[0]["index"];
               document.getElementById('county-name').innerHTML = "<strong>County: </strong>" + countyname;
            }
         }

         function show_county_stats(data){
            countySelected = true;
            var countyname = data.getAttribute("county-name");
            var result = counties.filter(obj =>{
               return obj["county"] == countyname && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
            })
            document.getElementById('county-currentIdx').innerHTML = "<strong>County Current: </strong>" + result[0]["index"];
            document.getElementById('county-name').innerHTML = "<strong>County: </strong>" + countyname;
            var circles = document.querySelectorAll("circle");
            if(prev_circle_idx != -1){
               circles[prev_circle_idx].setAttribute("fill", prev_color);
            }
            prev_circle = countyname;
            for (var i = 0; i < circles.length; i++){
                  if (circles[i].getAttribute("county-name") == countyname){
                     prev_color = circles[i].getAttribute("fill");
                     circles[i].setAttribute("fill", "green");
                     prev_circle_idx = i;
                  }
            }
         }
       
         // Display color for each state
         function display_color(data){
            var states = data.filter(state => {
                  return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
               });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });

            var sum = 0;
            for(var i = 0; i < states.length; i++){
               sum += parseFloat(states[i]["index"]);
            }
            var avg = sum / states.length;
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];
            for(var i = 0; i < states.length; i++){
               if (states[i]["index"] < avg){
                  var range = avg - min["index"];
                  var ratio = (avg - states[i]["index"]) / range;
                  var red = 182 + (218 - 182) * ratio;
                  var green = 149 + (233 - 149) * ratio;
                  var blue = 201 + (254 - 201) * ratio;
               }
               else{
                  var range = max["index"] - avg;
                  var ratio = (states[i]["index"] - avg) / range;
                  var red = 182 - (182 - 145) * ratio;
                  var green = 149 - (149 - 65) * ratio;
                  var blue = 201 - (201 - 148) * ratio;
               }
               // var ratio = (states[i]["index"] - min["index"]) / range;
               // // Predefined RGB color scale
               // // Min : 144 65 148
               // // Max : 216 234 254
               
               // var red = 144 + (216 - 144) * ratio;
               // var green = 65 - (234 - 65) * ratio;
               // var blue = 254 - (254 - 148) * ratio;

               var color = "rgb(" + red + "," + green + "," + blue + ")";
               document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill: ' + color + ';';
            }
         };

         function change_color(data, statename){
            var states = data.filter(state => {
               return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
            });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            var sum = 0;
            for(var i = 0; i < states.length; i++){
               sum += parseFloat(states[i]["index"]);
            }
            var avg = sum / states.length;
            var state = states.filter(state => {
               return state["state"] == statename;
            });
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];

            if (state[0]["index"] < avg){
                  var range = avg - min["index"];
                  var ratio = (avg - state[0]["index"]) / range;
                  var red = 182 + (218 - 182) * ratio;
                  var green = 149 + (233 - 149) * ratio;
                  var blue = 201 + (254 - 201) * ratio;
               }
               else{
                  var range = max["index"] - avg;
                  var ratio = (state[0]["index"] - avg) / range;
                  var red = 182 - (182 - 145) * ratio;
                  var green = 149 - (149 - 65) * ratio;
                  var blue = 201 - (201 - 148) * ratio;
               }

            var color = "rgb(" + red + "," + green + "," + blue + ")";
            var result = data.filter(obj => {
                  return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["index type"] == index_filter && obj["flavor"] == flavor_filter;
            });
            document.getElementById('currentIdx').innerHTML = "<strong>State Current: </strong>" + result[0]["index"];
            document.querySelector('[state-name="' + statename + '"]').style.cssText += 'fill: ' + color + ';';
         }

         // Tone down other state color
         function tonedown_color(data, statename){
            var states = data.filter(state => {
                  return state["year"] == year && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;
               });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            document.getElementById('min-value-p').innerHTML = min['index'];
            document.getElementById('max-value-p').innerHTML = max['index'];
            var sum = 0;
            for(var i = 0; i < states.length; i++){
               sum += parseFloat(states[i]["index"]);
            }
            var avg = sum / states.length;
            for(var i = 0; i < states.length; i++){
               if(states[i]["state"] != statename){
                  document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill:	#F8F8F8;';
               }
               else{
                  if (states[i]["index"] < avg){
                     var range = avg - min["index"];
                     var ratio = (avg - states[i]["index"]) / range;
                     var red = 182 + (218 - 182) * ratio;
                     var green = 149 + (233 - 149) * ratio;
                     var blue = 201 + (254 - 201) * ratio;
                  }
                  else{
                     var range = max["index"] - avg;
                     var ratio = (states[i]["index"] - avg) / range;
                     var red = 182 - (182 - 145) * ratio;
                     var green = 149 - (149 - 65) * ratio;
                     var blue = 201 - (201 - 148) * ratio;
                  }
                  var color = "rgb(" + red + "," + green + "," + blue + ")";
                  document.querySelector('[state-name="' + states[i]["state"] + '"]').style.cssText += 'fill: ' + color + ';';
               }
            }
            
         }

        // Display historical max and min data
        function display_hist(data, name){
            var states = data.filter(state => {
                  return state["state"] == name && state["type"] == type_filter && state["index type"] == index_filter && state["flavor"] == flavor_filter;;
            });
            var max = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
            });
            var min = states.reduce(function(prev, curr){
               return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
            });
            document.getElementById('hisMin').innerHTML = "<strong>Min:</strong> " + min['index'] + " (" + min['year'] + ")";
            document.getElementById('hisMax').innerHTML = "<strong>Max:</strong> " + max['index'] + " (" + max['year'] + ")";
        };

        // Check house type
        function typeCheckedOnClick(check){
            var checkboxes = document.getElementsByClassName("filter_type");
            for(var i = 0; i < checkboxes.length; i++){
               checkboxes.item(i).checked = false; // uncheck all checkboxes
            }
            type_filter = check.id;
            check.checked = true; // check the clicked checkbox
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
               display_hist(csvData, statename);
               histo = document.getElementById('histogram-img');
               img_name = 'Prediction Figures' + '/' + statename + '_' + type_filter + '_' + flavor_filter + '.png';
               histo.src = img_name;
               var state_counties = counties.filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
                     });

               var new_state_counties = [];
               for(var i = 0; i < state_counties.length; i++){
                  if(state_counties[i]["index"] != 0){
                        new_state_counties.push(state_counties[i]);
                  }
               }
               var dropdown = document.getElementById("dropdown-menu-list");
               while(dropdown.firstChild){
                  dropdown.removeChild(dropdown.firstChild);
               }
               state_counties = new_state_counties;
               display_dropdown(state_counties);
               var sum_index = 0;
               for(var i = 0; i < state_counties.length; i++){
                  sum_index += parseFloat(state_counties[i]["index"]);
               }
               var avg_index = sum_index / state_counties.length;
               //console.log(avg_index);
               var circles = document.querySelectorAll("circle");
               for (var i = 0; i < circles.length; i++){
                     circles[i].remove();
               }
               if(state_counties.length > 0){
                  var max = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               var svg = document.getElementById("us-map");
               for(var county of state_counties){
                  var county_path = document.querySelectorAll('[county-name="' + county["county"] + '"]');
                  var bbox = county_path[0].getBBox();
                  cx = bbox.x + bbox.width/2;
                  cy = bbox.y + bbox.height/2;
                  circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
                  // Max Radius = 6
                  radius = 6 * (county["index"] / max["index"]);
                  circle.setAttribute("cx", cx);
                  circle.setAttribute("cy", cy);
                  circle.setAttribute("r", radius);
                  if (county["county"] == max["county"]){
                     circle.setAttribute('fill', '#DE3163');
                  }
                  else if (county["county"] == min["county"]){
                     circle.setAttribute('fill', '#6495ED');
                  }
                  else{
                     circle.setAttribute('fill', '#FFFAA0');
                  }
                  circle.setAttribute("stroke", "black");
                  circle.setAttribute("index", county["index"]);
                  circle.setAttribute("onmouseover", "display_county_stats(this)");
                  // set circle attribute onclick
                  circle.setAttribute("onclick", "show_county_stats(this)");
                  
                  circle.setAttribute("county-name", county_path[0].getAttribute("county-name"));
                  svg.appendChild(circle);
               }
               }
            }
            if (check.id == "non-metro"){
               var checkboxes = document.getElementsByClassName("filter_flavor");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = true; // disable all checkboxes
               }
               var slider = document.getElementById("slider-range");
               if(slider.value < 1995){
                  year = 1995;
                  slider.setAttribute("value", 1995);  
                  show_value(year);
               }
               slider.setAttribute("min", 1995);
            }
            else{
               var checkboxes = document.getElementsByClassName("filter_flavor");
                  for(var i = 0; i < checkboxes.length; i++){
                     checkboxes.item(i).disabled = false; // disable all checkboxes
               }
               var slider = document.getElementById("slider-range");
               slider.setAttribute("min", 1975);
            }

            
        };

        // Check house flavor
         // Adjust year slider to change scope
         function show_value(value){
            document.getElementById("slider_value").innerHTML = value;  
            if(curr_selection == "us"){
               display_color(csvData);
            }
            else{
               statename = document.getElementById("displayName").innerText.split(": ")[1];
               change_color(csvData, statename);
               var state_counties = counties.filter(obj => {
                           return obj["state"] == statename && obj["year"] == year && obj["type"] == type_filter && obj["flavor"] == flavor_filter;
                     });

               var new_state_counties = [];
               for(var i = 0; i < state_counties.length; i++){
                  if(state_counties[i]["index"] != 0){
                        new_state_counties.push(state_counties[i]);
                  }
               }
               var dropdown = document.getElementById("dropdown-menu-list");
               while(dropdown.firstChild){
                  dropdown.removeChild(dropdown.firstChild);
               }
               state_counties = new_state_counties;
               display_dropdown(state_counties);
               var sum_index = 0;
               for(var i = 0; i < state_counties.length; i++){
                  sum_index += parseFloat(state_counties[i]["index"]);
               }
               var avg_index = sum_index / state_counties.length;
               //console.log(avg_index);
               var circles = document.querySelectorAll("circle");
               for (var i = 0; i < circles.length; i++){
                     circles[i].remove();
               }
               if(state_counties.length > 0){
                  var max = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) > parseInt(curr["index"]) ? prev : curr;
               });
               var min = state_counties.reduce(function(prev, curr){
                  return parseInt(prev["index"]) < parseInt(curr["index"]) ? prev : curr;
               });
               var svg = document.getElementById("us-map");
               for(var county of state_counties){
                  var county_path = document.querySelectorAll('[county-name="' + county["county"] + '"]');
                  var bbox = county_path[0].getBBox();
                  cx = bbox.x + bbox.width/2;
                  cy = bbox.y + bbox.height/2;
                  circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
                  // Max Radius = 6
                  radius = 6 * (county["index"] / max["index"]);
                  circle.setAttribute("cx", cx);
                  circle.setAttribute("cy", cy);
                  circle.setAttribute("r", radius);
                  if (county["county"] == max["county"]){
                     circle.setAttribute('fill', '#DE3163');
                  }
                  else if (county["county"] == min["county"]){
                     circle.setAttribute('fill', '#6495ED');
                  }
                  else{
                     circle.setAttribute('fill', '#FFFAA0');
                  }
                  circle.setAttribute("stroke", "black");
                  circle.setAttribute("index", county["index"]);
                  circle.setAttribute("onmouseover", "display_county_stats(this)");
                  // set circle attribute onclick
                  circle.setAttribute("onclick", "show_county_stats(this)");
                  
                  circle.setAttribute("county-name", county_path[0].getAttribute("county-name"));
                  svg.appendChild(circle);
               }
               }
            }
            
         };

         function getCentroid(element){
            var bbox = element.getBBox();
            return [bbox.x + bbox.width/2, bbox.y + bbox.height/2];
         }
    </script>
    <style>
    </style>
    <body>
        <div class = "container-xxl">
         <div class="page-title">
            <h1>United States House Price Index <a class= "btn" style="background:white !important; border:white; width: 40px;" title="House price index measures average price changes in repeat sales or refinancings on the same properties"><img src="about.jpg" style="height:100%;width:100%;"></a></h1>
         </div>
            <div class = "row align-items-start">
               <div class = "col" id="left-col">
                  <div style="margin-top:2em;">
                     <div class = "stat-rect">
                        <div class = "min-value">
                           <p id="min-value-p">0</p>
                        </div>
                        <div class = "max-value">
                           <p id="max-value-p">100</p>
                        </div>
                     </div>
                  </div>
                  <button class = "btn" id = "clearbtn" style="border-radius:10px;">Back</button>
                  <div class="dropdown" style="display:inline;">
                     <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false" style="border-radius:10px;">
                        Available Counties
                      </button>
                      <ul class="dropdown-menu" id="dropdown-menu-list">
                      </ul>
                  </div>
                  <div>
                     <script>
                        loadMap("usMap");
                     </script>
                  </div>
               </div>
               <div class = "col">
                  <div class="filter">
                     <div class = "filter-title" style="margin-bottom:-15px">
                        <p>YEAR</p>
                     </div>
                     <input type="range" id = "slider-range" class="form-range" min="1975" max="2022" step="1" value="2022" id="year-range" onchange=" year=this.value; show_value(this.value);">
                     <div style="text-align:center;">
                        <span id="slider_value" style="color:black;font-weight: bolder;">2022</span>
                     </div>
                  </div>
                  <div class="filter">
                     <div id="type-filter" style="margin-bottom:10px;">
                        <div class = "filter-title" style="margin-bottom:-15px;">
                           <p>House Types</p>
                        </div>
                        <div class="filter-value">
                           <input type="checkbox" checked class="filter_type" id="traditional" onclick="typeCheckedOnClick(this);"><p title="Traditional houses" style="display:inline; cursor:default;"> Traditional</p><br>
                           <input type="checkbox" class="filter_type" id= "non-metro" onclick="typeCheckedOnClick(this);"><p title = "Non-Metro houses are located in areas without the access to metro" style="display:inline; cursor:default;"> Non-Metro</p><br>
                        </div>
                     </div>
                     <div id ="flavor-filter">
                        <div class = "filter-title">
                           <p>Flavor</p>
                        </div>
                        <div class="filter-value">
                           <input type="checkbox" checked class="filter_flavor" id="all-transactions" onclick="flavorCheckedOnClick(this);"><p title= "Purchase-Only Index tracks mortgages used to purchase existing single-family homes" style = "display:inline; cursor:default;"> All-Transactions</p><br>
                           <input type="checkbox" class="filter_flavor" id="expanded-data" onclick="flavorCheckedOnClick(this);"><p title="Build on the purchase-only data by adding transcations from FHA and county recorder data" style="display:inline; cursor:default;"> Expanded-Data</p><br>
                           <input type="checkbox" class="filter_flavor" id="purchase-only" onclick="flavorCheckedOnClick(this);"><p title="All-Transactions indexes cover conventional and conforming mortgage transactions used to purchase or refinance an existing single-family home" style="display:inline; cursor:default;"> Purchase-Only</p><br>
                        </div>
                     </div>
                  </div>
   
                  <div class="display">
                     <div id="displayName">
                        <strong>States: </strong>
                     </div>
                     <div class = "index">
                        <div id="currentIdx"><strong>State Current:</strong></div>
                        <div id="hisMax"><strong>Max:</strong></div>
                        <div id="hisMin"><strong>Min:</strong></div>
                     </div>
                     <div id="county-name">
                        <strong>County: </strong>
                     </div>
                     <div class = "index">
                        <div id ="county-currentIdx"><Strong>County Current: </Strong></div>
                     </div>
                  </div>

                  <div class="histo">
                     <div id="histogram">
                        <img id="histogram-img" src="./Prediction Figures/main.jpeg" style="width: 100%;height:100%;">
                     </div>
                  </div>
               </div>
            </div>
         </div>
    </body>

</html>